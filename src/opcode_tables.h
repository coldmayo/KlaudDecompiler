#include <stdbool.h>
#include <stdio.h>

enum {
	AL, EAX, ES, CS, SS, DS, ONE, CL, XMM0, BND0, BAD, MM0,
	IMM8, IMM16, IMM32, REL8, REL32, PTR1632, R, RM,
	BYTE, WORD, DWORD, QWORD, FWORD, XMMWORD
};

typedef struct {
	bool hasModRM;   //modr/m ?
	char size;   // 
	const char *asmb;   //mnemonic
	uint8_t opcode;
	char arg_count;
	char arguments[4];
} Instruction;

static Instruction one_byte[255] = {
    {true, BYTE, "ADD ", 0x00, 2, {RM, R}},
    {true, DWORD, "ADD ", 0x01, 2, {RM, R}},
    {true, BYTE, "ADD ", 0x02, 2, {R, RM}},
    {true, DWORD, "ADD ", 0x03, 2, {R, RM}},
    {false, 0, "ADD ", 0x04, 2, {AL, IMM8}},
    {false, 0, "ADD ", 0x05, 2, {EAX, IMM32}},
    {false, 0, "PUSH ES", 0x06, 0, {0}},
    {false, 0, "POP ES", 0x07, 0, {0}},
    {true, BYTE, "OR ", 0x08, 2, {RM, R}},
    {true, DWORD, "OR ", 0x09, 2, {RM, R}},
    {true, BYTE, "OR ", 0x0A, 2, {RM, R}},
    {true, DWORD, "OR ", 0x0B, 2, {RM, R}},
    {false, 0, "OR ", 0x0C, 2, {AL, IMM8}},
    {false, 0, "OR ", 0x0D, 2, {EAX, IMM32}},
    {false, 0, "POP CS", 0x0E, 0, {0}},
    {true, BYTE, "ADC ", 0x10, 2, {RM, R}},
    {true, DWORD, "ADC ", 0x11, 2, {RM, R}},
    {true, BYTE, "ADC ", 0x12, 2, {R, RM}},
    {true, DWORD, "ADC ", 0x13, 2, {R, RM}},
    {false, 0, "ADC ", 0x14, 2, {AL, IMM8}},
    {false, 0, "ADC ", 0x15, 2, {EAX, IMM32}},
    {false, 0, "PUSH SS", 0x16, 0, {0}},
    {false, 0, "POP SS", 0x17, 0, {0}},
    {true, BYTE, "SBB ", 0x18, 2, {RM, R}},
    {true, DWORD, "SBB ", 0x19, 2, {RM, R}},
    {true, BYTE, "SBB ", 0x1A, 2, {R, RM}},
    {true, DWORD, "SBB ", 0x1B, 2, {R, RM}},
    {false, 0, "SBB ", 0x1C, 2, {AL, IMM8}},
    {false, 0, "SBB ", 0x1D, 2, {EAX, IMM32}},
    {false, 0, "PUSH DS", 0x1E, 0, {0}},
    {false, 0, "POP DS", 0x1F, 0, {0}},
    {true, BYTE, "AND ", 0x20, 2, {RM, R}},
    {true, DWORD, "AND ", 0x21, 2, {RM, R}},
    {true, BYTE, "AND ", 0x22, 2, {R, RM}},
    {true, DWORD, "AND ", 0x23, 2, {R, RM}},
    {false, 0, "AND ", 0x24, 2, {AL, IMM8}},
    {false, 0, "AND ", 0x25, 2, {EAX, IMM32}},
    {false, 0, "ES ", 0x26, 0, {0}},
    {false, 0, "DAA ", 0x27, 0, {0}},
    {true, BYTE, "SUB ", 0x28, 2, {RM, R}},
    {true, DWORD, "SUB ", 0x29, 2, {RM, R}},
    {true, BYTE, "SUB ", 0x2A, 2, {R, RM}},
    {true, DWORD, "SUB ", 0x2B, 2, {R, RM}},
    {false, 0, "SUB ", 0x2C, 2, {AL, IMM8}},
    {false, 0, "SUB ", 0x2D, 2, {EAX, IMM32}},
    {false, 0, "CS ", 0x2E, 0, {0}},
    {false, 0, " DAS ", 0x2F, 0, {0}},
    {true, BYTE, "XOR ", 0x30, 2, {RM, R}},
    {true, DWORD, "XOR ", 0x31, 2, {RM, R}},
    {true, BYTE, "XOR ", 0x32, 2, {R, RM}},
    {true, DWORD, "XOR ", 0x33, 2, {R, RM}},
    {false, 0, "XOR ", 0x34, 2, {AL, IMM8}},
    {false, 0, "XOR ", 0x35, 2, {EAX, IMM32}},
    {false, 0, "SS ", 0x36, 0, {0}},
    {false, 0, "AAA ", 0x37, 0, {0}},
    {true, BYTE, "CMP ", 0x38, 2, {RM, R}},
    {true, DWORD, "CMP ", 0x39, 2, {RM, R}},
    {true, BYTE, "CMP ", 0x3A, 2, {R, RM}},
    {true, DWORD, "CMP ", 0x3B, 2, {R, RM}},
    {false, 0, "CMP ", 0x3C, 2, {AL, IMM8}},
    {false, 0, "CMP ", 0x3D, 2, {EAX, IMM32}},
    {false, 0, "DS ", 0x3E, 0, {0}},
    {false, 0, "AAS ", 0x3F, 0, {0}},
    {false, 0, "INC EAX", 0x40, 0, {0}},
    {false, 0, "INC ECX", 0x41, 0, {0}},
    {false, 0, "INC EDX", 0x42, 0, {0}},
    {false, 0, "INC EBX", 0x43, 0, {0}},
    {false, 0, "INC ESP", 0x44, 0, {0}},
    {false, 0, "INC EBP", 0x45, 0, {0}},
    {false, 0, "INC ESI", 0x46, 0, {0}},
    {false, 0, "INC EDI", 0x47, 0, {0}},
    {false, 0, "DEC EAX", 0x48, 0, {0}},
    {false, 0, "DEC ECX", 0x49, 0, {0}},
    {false, 0, "DEC EDX", 0x4A, 0, {0}},
    {false, 0, "DEC EBX", 0x4B, 0, {0}},
    {false, 0, "DEC ESP", 0x4C, 0, {0}},
    {false, 0, "DEC EBP", 0x4D, 0, {0}},
    {false, 0, "INC ESI", 0x4E, 0, {0}},
    {false, 0, "INC EDI", 0x4F, 0, {0}},
    {false, 0, "PUSH EAX", 0x50, 0, {0}},
    {false, 0, "PUSH ECX", 0x51, 0, {0}},
    {false, 0, "PUSH EDX", 0x52, 0, {0}},
    {false, 0, "PUSH EBX", 0x53, 0, {0}},
    {false, 0, "PUSH ESP", 0x54, 0, {0}},
    {false, 0, "PUSH EBP", 0x55, 0, {0}},
    {false, 0, "PUSH ESI", 0x56, 0, {0}},
    {false, 0, "PUSH EDI", 0x57, 0, {0}},
    {false, 0, "POP EAX", 0x58, 0, {0}},
    {false, 0, "POP ECX", 0x59, 0, {0}},
    {false, 0, "POP EDX", 0x5A, 0, {0}},
    {false, 0, "POP EBX", 0x5B, 0, {0}},
    {false, 0, "POP ESP", 0x5C, 0, {0}},
    {false, 0, "POP EBP", 0x5D, 0, {0}},
    {false, 0, "POP ESI", 0x5E, 0, {0}},
    {false, 0, "POP EDI", 0x5F, 0, {0}},
    {false, 0, "PUSHA", 0x60, 0, {0}},
    {false, 0, "POPA", 0x61, 0, {0}},
    {true, QWORD, "BOUND ", 0x62, 2, {R, RM}},
    {true, WORD, "ARPL ", 0x63, 0, {RM, R}},
    {false, 0, "FS ", 0x64, 0, {0}},
    {false, 0, "GS ", 0x65, 0, {0}},
    {false, 0, "DATA16 ", 0x66, 0, {0}},
    {false, 0, "ADDR16 ", 0x67, 0, {0}},
    {false, 0, "PUSH ", 0x68, 1, {IMM32}},
    {true, DWORD, "IMUL ", 0x69, 3, {R, RM, IMM32}},
    {false, 0, "PUSH ", 0x6A, 1, {IMM8}},
    {true, DWORD, "IMUL ", 0x6B, 3, {R, RM, IMM8}},
    {false, 0, "INS BYTE PTR es:[edi],dx", 0x6C, 0, {0}},
	{false, 0, "INS DWORD PTR es:[edi],dx", 0x6D, 0, {0}},
	{false, 0, "OUTS dx,BYTE PTR ds:[esi]", 0x6E, 0, {0}},
	{false, 0, "OUTS dx,DWORD PTR ds:[esi]", 0x6F, 0, {0}},
	{false, 0, "JO ", 0x70, 1, {REL8}},
	{false, 0, "JNO ", 0x71, 1, {REL8}},
	{false, 0, "JB ", 0x72, 1, {REL8}},
	{false, 0, "JNB ", 0x73, 1, {REL8}},
	{false, 0, "JZ ", 0x74, 1, {REL8}},
	{false, 0, "JNZ ", 0x75, 1, {REL8}},
	{false, 0, "JBE ", 0x76, 1, {REL8}},
	{false, 0, "JNBE ", 0x77, 1, {REL8}},
	{false, 0, "JS ", 0x78, 1, {REL8}},
	{false, 0, "JNS ", 0x79, 1, {REL8}},
	{false, 0, "JP ", 0x7A, 1, {REL8}},
	{false, 0, "JNP ", 0x7B, 1, {REL8}},
	{false, 0, "JL ", 0x7C, 1, {REL8}},
	{false, 0, "JNL ", 0x7D, 1, {REL8}},
	{false, 0, "JLE ", 0x7E, 1, {REL8}},
	{false, 0, "JNLE ", 0x7F, 1, {REL8}},
	{true, BYTE, "ADD ", 0x80, 2, {RM, IMM8}},
	{true, DWORD, "ADD ", 0x81, 2, {RM, IMM32}},
	{false, 0, ".byte 0x82", 0x82, 0, {0}},
	{true, DWORD, "ADC ", 0x83, 2, {RM, IMM8}},
	{true, BYTE, "TEST ", 0x84, 2, {RM, R}},
	{true, DWORD, "TEST ", 0x85, 2, {RM, R}},
	{true, BYTE, "XCHG ", 0x86, 2, {RM, R}},
	{true, DWORD, "XCHG ", 0x87, 2, {RM, R}}
	{true, BYTE, "MOV ", 0x88, 2, {RM, R}},
	{true, DWORD, "MOV ", 0x89, 2, {RM, R}},
	{true, BYTE, "MOV ", 0x8A, 2, {R, RM}},
	{true, DWORD, "MOV ", 0x8B, 2, {R, RM}},
	{true, WORD, "MOV ", 0x8C, 2, {RM, SS}},
	{true, 0, "LEA ", 0x8D, 2, {R, RM}},
	{true, WORD, "MOV SS,", 0x8E, 1, {RM}},
	{true, DWORD, "POP ", 0x8F, 1, {RM}},
	{false, 0, "NOP", 0x90, 0, {0}},
	{false, 0, "XCHG ECX,EAX", 0x91, 0, {0}},
	{false, 0, "XCHG EDX,EAX", 0x92, 0, {0}},
	{false, 0, "XCHG EBX,EAX", 0x93, 0, {0}},
	{false, 0, "XCHG ESP,EAX", 0x94, 0, {0}},
	{false, 0, "XCHG EBP,EAX", 0x95, 0, {0}},
	{false, 0, "XCHG ESI,EAX", 0x96, 0, {0}},
	{false, 0, "XCHG EDI,EAX", 0x97, 0, {0}},
	{false, 0, "CWDE", 0x98, 0, {0}},
	{false, 0, "CDQ", 0x99, 0, {0}},
	{false, 0, "CALL ", 0x9A, 1, {PTR1632}},
	{false, 0, "FWAIT", 0x9B, 0, {0}},
	{false, 0, "PUSHF", 0x9C, 0, {0}},
	{false, 0, "POPF", 0x9D, 0, {0}},
	{false, 0, "SAHF", 0x9E, 0, {0}},
	{false, 0, "LAHF", 0x9F, 0, {0}},
	{false, 0, "MOV AL,DS:", 0xA0, 1, {IMM8}},
	{false, 0, "MOV EAX,DS:", 0xA1, 1, {IMM8}},
	{false, 0, "MOV DS:", 0xA2, 2, {IMM8, AL}},
	{false, 0, "MOV DS:", 0xA3, 2, {IMM32, EAX}},
	{false, 0, "MOVS BYTE PTR es:[edi],BYTE PTR ds:[esi]", 0xA4, 0, {0}},
	{false, 0, "MOVS DWORD PTR es:[edi],DWORD PTR ds:[esi]", 0xA5, 0, {0}},
	{false, 0, "CMPS BYTE PTR es:[esi],BYTE PTR ds:[edi]", 0xA6, 0, {0}},
	{false, 0, "CMPS DWORD PTR es:[esi],DWORD PTR ds:[edi]", 0xA7, 0, {0}},
	{false, 0, "TEST AL,", 0xA8, 1, {IMM8}},
	{false, 0, "TEST EAX,", 0xA9, 1, {IMM32}},
	{false, 0, "stos BYTE PTR es:[edi],al", 0xAA, 0, {0}},
	{false, 0, "stos DWORD PTR es:[edi],eax", 0xAB, 0, {0}},
	{false, 0, "lods al,BYTE PTR ds:[esi]", 0xAC, 0, {0}},
	{false, 0, "lods eax,DWORD PTR ds:[esi]", 0xAD, 0, {0}},
	{false, 0, "scas al,BYTE PTR es:[edi]", 0xAE, 0, {0}},
	{false, 0, "scas eax,DWORD PTR es:[edi]", 0xAF, 0, {0}},
	{false, 0, "MOV al,", 0xB0, 1, {IMM8}},
	{false, 0, "MOV cl," 0xB1, 1, {IMM8}},
	{false, 0, "MOV dl", 0xB2, 1, {IMM8}},
	{false, 0, "MOV bl,", 0xB3, 1, {IMM8}},
	{false, 0, "MOV ah,", 0xB4, 1, {IMM8}},
	{false, 0, "MOV ch,", 0xB5, 1, {IMM8}},
	{false, 0, "MOV dh,", 0xB6, 1, {IMM8}},
	{false, 0, "MOV bh,", 0xB7, 1, {IMM8}},
	{false, 0, "MOV eax,", 0xB8, 1, {IMM32}},
	{false, 0, "MOV ecx,", 0xB9, 1, {IMM32}},
	{false, 0, "MOV edx,", 0xBA, 1, {IMM32}},
	{false, 0, "MOV ebx,", 0xBB, 1, {IMM32}},
	{false, 0, "MOV esp,", 0xBC, 1, {IMM32}},
	{false, 0, "MOV ebp,", 0xBD, 1, {IMM32}},
	{false, 0, "MOV esi,", 0xBE, 1, {IMM32}},
	{false, 0, "MOV edi,", 0xBF, 0, {IMM32}},
	{true, BYTE, "ROL ", 0xC0, 2, {RM, IMM8}},
	{true, DWORD, "ROL ", 0xC1, 2, {RM, IMM8}},
	{false, 0, "RET ", 0xC2, 1, {IMM16}},
	{false, 0, "RET ", 0xC3, 0, {0}},
	{true, FWORD, "LES EAX,", 0xC4, 1, {RM}},
	{true, FWORD, "LDS eax,", 0xC5, 1, {RM}},
	{true, BYTE, "MOV ", 0xC6, 2, {RM, IMM8}},
	{true, DWORD, "MOV ", 0xC7, 2, {RM, IMM32}},
	{false, 0, "ENTER ", 0xC8, 2, {IMM16, IMM8}},
	{false, 0, "LEAVE", 0xC9, 0, {0}},
	{false, 0, "RETF ", 0xCA, 1, {IMM16}},
	{false, 0, "RETF", 0xCB, 0, {0}},
	{false, 0, "INT3", 0xCC, 0, {0}},
	{false, 0, "INT ", 0xCD, 1, {IMM8}},
	{false, 0, "INTO", 0xCE, 0, {0}},
	{false, 0, "IRET", 0xCF, 0, {0}},
	{true, BYTE, "ROL ", 0xD0, 2, {RM, ONE}},
	{true, DWORD, "ROL ", 0xD1, 2, {RM, ONE}},
	{true, BYTE, "ROL ", 0xD2, 2, {R, CL}},
	{true, DWORD, "ROL ", 0xD3, 2, {R, CL}},
	{false, 0, "AAM ", 0xD4, 1, {IMM8}},
	{false, 0, "AAD ", 0xD5, 1, {IMM8}},
	{false, 0, ".BYTE 0xd6", 0xD6, 0, {0}},
	{false, 0, "xlat BYTE PTR ds:[ebx]", 0xD7, 0, {0}},
	{true, DWORD, "FADD ", 0xD8, 1, {RM}},
	{true, DWORD, "FLD ", 0xD9, 1, {RM}},
	{true, DWORD, "FIADD ", 0xDA, 1, {RM}},
	{true, DWORD, "FILD ", 0xDB, 1, {RM}},
	{true, QWORD, "FADD ", 0xDC, 1, {RM}},
	{true, QWORD, "FLD ", 0xDD, 1, {RM}},
	{true, WORD, "FIADD ", 0xDE, 1, {RM}},
	{true, WORD, "FILD ", 0xDF, 1, {RM}},
	{false, 0, "LOOPNE ", 0xE0, 1, {REL8}},
	{false, 0, "LOOPE ", 0xE1, 1, {REL8}},
	{false, 0, "LOOP ", 0xE2, 1, {REL8}},
	{false, 0, "JECXZ ", 0xE3, 1, {REL8}},
	{false, 0, "IN al,", 0xE4, 1, {IMM8}},
	{false, 0, "IN eax,", 0xE5, 1, {IMM8}},
	{false, 0, "OUT ", 0xE6, 2, {IMM8, AL}},
	{false, 0, "OUT ", 0xE7, 2, {IMM8, EAX}},
	{false, 0, "CALL ", 0xE8, 1, {REL32}},
	{false, 0, "JMP ", 0xE9, 1, {REL32}},
	{false, 0, "JMPF ", 0xEA, 1, {PTR1632}},
	{false, 0, "JMP ", 0xEB, 1, {REL8}},
	{false, 0, "IN al,dx", 0xEC, 0, {0}},
	{false, 0, "IN eax,dx", 0xED, 0, {0}},
	{false, 0, "out dx,al", 0xEE, 0, {0}},
	{false, 0, "out dx,eax", 0xEF, 0, {0}},
	{false, 0, "LOCK ", 0xF0, 0, {0}},
	{false, 0, "ICEBP", 0xF1, 0, {0}},
	{false, 0, "REPNZ ", 0xF2, 0, {0}},
	{false, 0, "REPZ ", 0xF3, 0, {0}},
	{false, 0, "HLT", 0xF4, 0, {0}},
	{false, 0, "CMC", 0xF5, 0, {0}},
	{true, BYTE, "TEST ", 0xF6, 2, {RM, IMM8}},
	{true, DWORD, "TEST ", 0xF7, 2, {RM, IMM32}},
	{false, 0, "CLC", 0xF8, 0, {0}},
	{false, 0, "STC", 0xF9, 0, {0}},
	{false, 0, "CLI", 0xFA, 0, {0}},
	{false, 0, "STI", 0xFB, 0, {0}},
	{false, 0, "CLD", 0xFC, 0, {0}},
	{false, 0, "STD", 0xFD, 0, {0}},
	{true, BYTE, "INC ", 0xFE, 1, {RM}},
	{true, DWORD, "INC ", 0xFF, 1, {RM}}
};

static Instruction two_byte[255] = {
    {true, WORD, "SLLDT ", 1, {RM}},
    {true, 0, "SGDTD ", 1, {RM}}
};
